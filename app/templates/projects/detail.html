{% extends "base.html" %}

{% block title %}Project - Record Linkage{% endblock %}

{% block navbar %}
{% set active = "projects" %}
{% include "components/navbar.html" with context %}
{% endblock %}

{% block content %}
<div class="py-10">
    <header class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
            <div class="min-w-0 flex-1">
                <h1 id="project-name" class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl">
                    Loading...
                </h1>
                <p id="project-description" class="mt-1 text-sm text-gray-500"></p>
            </div>
            <div class="mt-4 flex md:ml-4 md:mt-0 space-x-3">
                <span id="project-type-badge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"></span>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
        <!-- Workflow Steps -->
        <nav class="mb-8">
            <ol class="flex items-center justify-center space-x-5">
                <li class="flex items-center">
                    <a href="#datasets" class="flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800">
                        <span class="flex h-8 w-8 items-center justify-center rounded-full bg-indigo-100 text-indigo-600">1</span>
                        <span class="ml-2">Datasets</span>
                    </a>
                </li>
                <li class="flex items-center">
                    <div class="h-0.5 w-8 bg-gray-200"></div>
                </li>
                <li class="flex items-center">
                    <a id="link-mapping" href="#" class="flex items-center text-sm font-medium text-gray-500 hover:text-gray-700">
                        <span class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 text-gray-600">2</span>
                        <span class="ml-2">Mapping</span>
                    </a>
                </li>
                <li class="flex items-center">
                    <div class="h-0.5 w-8 bg-gray-200"></div>
                </li>
                <li class="flex items-center">
                    <a id="link-config" href="#" class="flex items-center text-sm font-medium text-gray-500 hover:text-gray-700">
                        <span class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 text-gray-600">3</span>
                        <span class="ml-2">Config</span>
                    </a>
                </li>
                <li class="flex items-center">
                    <div class="h-0.5 w-8 bg-gray-200"></div>
                </li>
                <li class="flex items-center">
                    <a id="link-labeling" href="#" class="flex items-center text-sm font-medium text-gray-500 hover:text-gray-700">
                        <span class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 text-gray-600">4</span>
                        <span class="ml-2">Labeling</span>
                    </a>
                </li>
                <li class="flex items-center">
                    <div class="h-0.5 w-8 bg-gray-200"></div>
                </li>
                <li class="flex items-center">
                    <a id="link-linkage" href="#" class="flex items-center text-sm font-medium text-gray-500 hover:text-gray-700">
                        <span class="flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 text-gray-600">5</span>
                        <span class="ml-2">Run Linkage</span>
                    </a>
                </li>
            </ol>
        </nav>

        <!-- Datasets Section -->
        <div id="datasets" class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-base font-semibold leading-6 text-gray-900">Datasets</h3>
                <button onclick="showUploadModal()" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                    <svg class="-ml-0.5 mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Upload Dataset
                </button>
            </div>
            <div id="datasets-list" class="divide-y divide-gray-200">
                <div class="p-6 text-center text-gray-500">Loading datasets...</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <a id="btn-mapping" href="#" class="relative flex items-center space-x-3 rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm hover:border-indigo-400">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                </div>
                <div class="min-w-0 flex-1">
                    <span class="absolute inset-0"></span>
                    <p class="text-sm font-medium text-gray-900">Column Mapping</p>
                    <p class="text-sm text-gray-500">Map columns between datasets</p>
                </div>
            </a>

            <a id="btn-config" href="#" class="relative flex items-center space-x-3 rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm hover:border-indigo-400">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
                <div class="min-w-0 flex-1">
                    <span class="absolute inset-0"></span>
                    <p class="text-sm font-medium text-gray-900">Configure Comparison</p>
                    <p class="text-sm text-gray-500">Set up matching rules</p>
                </div>
            </a>

            <a id="btn-labeling" href="#" class="relative flex items-center space-x-3 rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm hover:border-indigo-400">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>
                </div>
                <div class="min-w-0 flex-1">
                    <span class="absolute inset-0"></span>
                    <p class="text-sm font-medium text-gray-900">Active Learning</p>
                    <p class="text-sm text-gray-500">Label pairs to train model</p>
                </div>
            </a>

            <a id="btn-linkage" href="#" class="relative flex items-center space-x-3 rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm hover:border-indigo-400">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div class="min-w-0 flex-1">
                    <span class="absolute inset-0"></span>
                    <p class="text-sm font-medium text-gray-900">Run Linkage</p>
                    <p class="text-sm text-gray-500">Execute record linkage</p>
                </div>
            </a>
        </div>
    </main>
</div>

<!-- Upload Modal -->
<div id="upload-modal" class="hidden relative z-10" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                <form id="upload-form" enctype="multipart/form-data">
                    <div>
                        <h3 class="text-lg font-semibold leading-6 text-gray-900">Upload Dataset</h3>
                        <div class="mt-4 space-y-4">
                            <div>
                                <label for="dataset-name" class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="dataset-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                            </div>
                            <div>
                                <label for="dataset-role" class="block text-sm font-medium text-gray-700">Role</label>
                                <select id="dataset-role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                                    <option value="source">Source</option>
                                    <option value="target">Target</option>
                                    <option value="dedupe">Dedupe (single dataset)</option>
                                </select>
                            </div>
                            <div>
                                <label for="dataset-file" class="block text-sm font-medium text-gray-700">CSV File</label>
                                <input type="file" id="dataset-file" accept=".csv" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                        </div>
                    </div>
                    <div id="upload-error" class="hidden mt-4 text-sm text-red-600 bg-red-50 p-3 rounded-md"></div>
                    <div id="upload-progress" class="hidden mt-4">
                        <div class="relative pt-1">
                            <div class="overflow-hidden h-2 text-xs flex rounded bg-indigo-200">
                                <div id="progress-bar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                        <button type="submit" class="inline-flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 sm:col-start-2">
                            Upload
                        </button>
                        <button type="button" onclick="hideUploadModal()" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const projectId = {{ project_id }};

    if (!isAuthenticated()) {
        window.location.href = '/login';
    }

    // Set up navigation links
    document.getElementById('link-mapping').href = `/projects/${projectId}/mapping`;
    document.getElementById('link-config').href = `/projects/${projectId}/config`;
    document.getElementById('link-labeling').href = `/projects/${projectId}/labeling`;
    document.getElementById('link-linkage').href = `/projects/${projectId}/linkage`;
    document.getElementById('btn-mapping').href = `/projects/${projectId}/mapping`;
    document.getElementById('btn-config').href = `/projects/${projectId}/config`;
    document.getElementById('btn-labeling').href = `/projects/${projectId}/labeling`;
    document.getElementById('btn-linkage').href = `/projects/${projectId}/linkage`;

    async function loadProject() {
        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                headers: { 'Authorization': 'Bearer ' + getAuthToken() }
            });

            if (response.status === 401) {
                removeAuthToken();
                window.location.href = '/login';
                return;
            }

            const project = await response.json();

            document.getElementById('project-name').textContent = project.name;
            document.getElementById('project-description').textContent = project.description || '';

            const badge = document.getElementById('project-type-badge');
            if (project.linkage_type === 'deduplication') {
                badge.textContent = 'Deduplication';
                badge.className = 'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-yellow-100 text-yellow-800';
            } else {
                badge.textContent = 'Record Linkage';
                badge.className = 'inline-flex items-center rounded-full px-3 py-1 text-sm font-medium bg-green-100 text-green-800';
            }

            // Render datasets
            const datasetsList = document.getElementById('datasets-list');
            if (project.datasets && project.datasets.length > 0) {
                datasetsList.innerHTML = project.datasets.map(ds => `
                    <div class="px-4 py-4 sm:px-6 flex items-center justify-between">
                        <div class="flex items-center">
                            <svg class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125" />
                            </svg>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">${ds.name}</p>
                                <p class="text-sm text-gray-500">${ds.row_count?.toLocaleString() || '?'} rows, ${ds.column_names?.length || '?'} columns</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-800">${ds.role}</span>
                            <a href="/datasets/${ds.id}" class="text-indigo-600 hover:text-indigo-500 text-sm">View</a>
                        </div>
                    </div>
                `).join('');
            } else {
                datasetsList.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <p>No datasets uploaded yet</p>
                        <button onclick="showUploadModal()" class="mt-2 text-indigo-600 hover:text-indigo-500">Upload your first dataset</button>
                    </div>
                `;
            }

        } catch (error) {
            console.error('Failed to load project:', error);
        }
    }

    function showUploadModal() {
        document.getElementById('upload-modal').classList.remove('hidden');
    }

    function hideUploadModal() {
        document.getElementById('upload-modal').classList.add('hidden');
        document.getElementById('upload-form').reset();
        document.getElementById('upload-error').classList.add('hidden');
        document.getElementById('upload-progress').classList.add('hidden');
    }

    document.getElementById('upload-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('dataset-name').value;
        const role = document.getElementById('dataset-role').value;
        const file = document.getElementById('dataset-file').files[0];
        const errorDiv = document.getElementById('upload-error');
        const progressDiv = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');

        errorDiv.classList.add('hidden');
        progressDiv.classList.remove('hidden');

        const formData = new FormData();
        formData.append('name', name);
        formData.append('role', role);
        formData.append('project_id', projectId);
        formData.append('file', file);

        try {
            const response = await fetch('/api/datasets/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + getAuthToken()
                },
                body: formData
            });

            if (response.ok) {
                hideUploadModal();
                loadProject();
                showToast('Dataset uploaded successfully', 'success');
            } else {
                const data = await response.json();
                errorDiv.textContent = data.detail || 'Upload failed';
                errorDiv.classList.remove('hidden');
                progressDiv.classList.add('hidden');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred during upload';
            errorDiv.classList.remove('hidden');
            progressDiv.classList.add('hidden');
        }
    });

    loadProject();
</script>
{% endblock %}
